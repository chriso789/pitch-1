name: Claude AI Bug Detection

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    types: [opened, synchronize, reopened]
  schedule:
    # Run weekly on Mondays at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  detect-bugs:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Analyze code for bugs with Claude
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          # Focus on critical areas
          CRITICAL_FILES=(
            "src/features/leads"
            "src/features/jobs"
            "src/features/sales"
            "supabase/functions"
          )
          
          for area in "${CRITICAL_FILES[@]}"; do
            if [ -d "$area" ]; then
              echo "### Analyzing: $area" >> analysis_bundle.txt
              find "$area" -type f \( -name "*.ts" -o -name "*.tsx" \) -exec sh -c '
                echo "#### File: $1" >> analysis_bundle.txt
                echo "```typescript" >> analysis_bundle.txt
                head -n 200 "$1" >> analysis_bundle.txt
                echo "```" >> analysis_bundle.txt
              ' _ {} \;
            fi
          done
          
          # Create bug detection prompt
          cat > bug_prompt.json << 'EOF'
          {
            "prompt": "Analyze this code for potential bugs and issues. Focus on:\n\n1. **Runtime Errors** - Null pointer exceptions, undefined references, type mismatches\n2. **Logic Errors** - Incorrect conditions, off-by-one errors, race conditions\n3. **Data Issues** - SQL injection, data validation gaps, incorrect queries\n4. **Memory Leaks** - Unclosed connections, unsubscribed observables, infinite loops\n5. **Edge Cases** - Unhandled error scenarios, boundary conditions\n6. **Security Vulnerabilities** - Authentication bypass, data exposure, XSS/CSRF\n\nFor each issue found:\n- **Severity**: Critical/High/Medium/Low\n- **Location**: File and line/function\n- **Issue**: Clear description\n- **Impact**: What could go wrong\n- **Fix**: Specific code fix\n\nOnly report genuine bugs, not style preferences.\n\n$(cat analysis_bundle.txt)",
            "model": "anthropic/claude-sonnet-4-5",
            "system_prompt": "You are an expert bug hunter with 15 years of experience. Find real bugs that could cause production issues, not style problems. Be thorough but only report genuine issues.",
            "max_tokens": 16384,
            "temperature": 0.1
          }
          EOF
          
          # Call Claude AI
          BUG_RESPONSE=$(curl -s -X POST \
            "$SUPABASE_URL/functions/v1/ai-claude-processor" \
            -H "Authorization: Bearer $SUPABASE_ANON_KEY" \
            -H "Content-Type: application/json" \
            -d @bug_prompt.json)
          
          # Save bug report
          echo "$BUG_RESPONSE" | jq -r '.response' > bug_report.md

      - name: Parse bug severity
        id: severity
        run: |
          CRITICAL_COUNT=$(grep -c "Severity.*Critical" bug_report.md || echo "0")
          HIGH_COUNT=$(grep -c "Severity.*High" bug_report.md || echo "0")
          
          echo "critical=$CRITICAL_COUNT" >> $GITHUB_OUTPUT
          echo "high=$HIGH_COUNT" >> $GITHUB_OUTPUT
          
          if [ "$CRITICAL_COUNT" -gt 0 ] || [ "$HIGH_COUNT" -gt 0 ]; then
            echo "issues_found=true" >> $GITHUB_OUTPUT
          else
            echo "issues_found=false" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub issues for critical bugs
        if: steps.severity.outputs.issues_found == 'true'
        uses: actions/github-script@v7
        env:
          BUG_REPORT: ${{ steps.severity.outputs.critical }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const bugReport = fs.readFileSync('bug_report.md', 'utf8');
            
            // Check if similar issue already exists
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'bug,claude-ai-detected'
            });
            
            const today = new Date().toISOString().split('T')[0];
            const issueTitle = `üêõ Claude AI Bug Detection Report - ${today}`;
            
            const alreadyReported = existingIssues.data.some(issue => 
              issue.title.includes(today)
            );
            
            if (!alreadyReported) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issueTitle,
                body: `## üêõ Automated Bug Detection Report\n\n${bugReport}\n\n---\n**Critical Issues:** ${{ steps.severity.outputs.critical }}\n**High Priority Issues:** ${{ steps.severity.outputs.high }}\n\n*Detected by Claude Sonnet 4.5 via Lovable AI Gateway*`,
                labels: ['bug', 'claude-ai-detected', 'needs-triage']
              });
            }

      - name: Comment on PR (if PR context)
        if: github.event_name == 'pull_request' && steps.severity.outputs.issues_found == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const bugReport = fs.readFileSync('bug_report.md', 'utf8');
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ‚ö†Ô∏è Claude AI Bug Detection\n\n${bugReport}\n\n---\n*Powered by Claude Sonnet 4.5 via Lovable AI Gateway*`
            });

      - name: Fail if critical bugs found
        if: steps.severity.outputs.critical > 0
        run: |
          echo "::error::‚ùå Critical bugs detected! Review the bug report."
          exit 1
