openapi: 3.0.3
info:
  title: PITCH Roofing CRM — Job Budgets (Pre‑Cap / Cap‑Out)
  version: "1.0.0"
tags:
  - name: Budgets
paths:
  /jobs/{id}/budgets/snapshot:
    post:
      summary: Snapshot Pre‑Cap (locked) and create initial Cap‑Out from estimate lines
      tags: [Budgets]
      x-supabase-rpc: api_snapshot_precap_and_capout
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string, format: uuid }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [lines]
              properties:
                lines:
                  type: array
                  items:
                    type: object
                    properties:
                      kind: { type: string, enum: [MATERIAL, LABOR] }
                      code: { type: string }
                      name: { type: string }
                      uom: { type: string }
                      qty: { type: number }
                      unit_price: { type: number }
                      unit_cost: { type: number }
                      markup_pct: { type: number }
                      markup_fixed: { type: number }
                overhead_amount: { type: number, default: 0 }
                commission_amount: { type: number, default: 0 }
                misc_amount: { type: number, default: 0 }
                estimate_ref: { type: string, format: uuid, nullable: true }
      responses:
        "200":
          description: OK
  /jobs/{id}/budgets/capout/refresh:
    post:
      summary: Recompute Cap‑Out from job cost events (and invoice mirror if present)
      tags: [Budgets]
      x-supabase-rpc: api_capout_refresh
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string, format: uuid }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
  /jobs/{id}/budgets:
    get:
      summary: Read Pre‑Cap and Cap‑Out versions for a job
      tags: [Budgets]
      x-supabase-rpc: api_job_budgets_get
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string, format: uuid }
      responses:
        "200":
          description: OK
